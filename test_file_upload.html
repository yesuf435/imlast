<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IMç³»ç»Ÿ - æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .upload-area {
        border: 2px dashed #ddd;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        margin: 20px 0;
        transition: all 0.3s ease;
      }
      .upload-area:hover {
        border-color: #007bff;
        background-color: #f8f9fa;
      }
      .upload-area.dragover {
        border-color: #007bff;
        background-color: #e3f2fd;
      }
      input[type="file"] {
        margin: 10px 0;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
        display: none;
      }
      .success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .file-info {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }
      .progress {
        width: 100%;
        height: 20px;
        background: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }
      .progress-bar {
        height: 100%;
        background: #007bff;
        width: 0%;
        transition: width 0.3s ease;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ“ IMç³»ç»Ÿæ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h1>
      <p>æµ‹è¯•æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ï¼Œæ”¯æŒå›¾ç‰‡ã€æ–‡æ¡£ç­‰å¤šç§æ ¼å¼</p>

      <div class="upload-area" id="uploadArea">
        <h3>æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</h3>
        <input
          type="file"
          id="fileInput"
          multiple
          accept="image/*,.pdf,.doc,.docx,.txt,.zip,.rar"
        />
        <br />
        <button onclick="document.getElementById('fileInput').click()">
          é€‰æ‹©æ–‡ä»¶
        </button>
        <button onclick="uploadFiles()" id="uploadBtn" disabled>
          ä¸Šä¼ æ–‡ä»¶
        </button>
      </div>

      <div class="progress" id="progressContainer" style="display: none">
        <div class="progress-bar" id="progressBar"></div>
      </div>

      <div id="result" class="result"></div>

      <div id="fileList"></div>

      <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
      <ul>
        <li>
          æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼šå›¾ç‰‡ (jpg, png, gif)ã€æ–‡æ¡£ (pdf, doc, docx,
          txt)ã€å‹ç¼©åŒ… (zip, rar)
        </li>
        <li>æ–‡ä»¶å¤§å°é™åˆ¶ï¼š50MB</li>
        <li>ä¸Šä¼ çš„æ–‡ä»¶ä¼šä¿å­˜åˆ°æœåŠ¡å™¨çš„ uploads ç›®å½•</li>
        <li>ä¸Šä¼ æˆåŠŸåå¯ä»¥å‘é€ç»™å…¶ä»–ç”¨æˆ·</li>
      </ul>

      <h3>ğŸ”— APIæµ‹è¯•</h3>
      <button onclick="testHealth()">æµ‹è¯•åç«¯å¥åº·çŠ¶æ€</button>
      <button onclick="testAuth()">æµ‹è¯•è®¤è¯çŠ¶æ€</button>
      <div id="apiResult"></div>
    </div>

    <script>
      const API_BASE_URL = "http://localhost:3001";
      let selectedFiles = [];

      // æ–‡ä»¶é€‰æ‹©å¤„ç†
      document
        .getElementById("fileInput")
        .addEventListener("change", function (e) {
          selectedFiles = Array.from(e.target.files);
          updateFileList();
          updateUploadButton();
        });

      // æ‹–æ‹½å¤„ç†
      const uploadArea = document.getElementById("uploadArea");

      uploadArea.addEventListener("dragover", function (e) {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });

      uploadArea.addEventListener("dragleave", function (e) {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
      });

      uploadArea.addEventListener("drop", function (e) {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        selectedFiles = Array.from(e.dataTransfer.files);
        updateFileList();
        updateUploadButton();
      });

      function updateFileList() {
        const fileList = document.getElementById("fileList");
        if (selectedFiles.length === 0) {
          fileList.innerHTML = "";
          return;
        }

        let html = "<h3>ğŸ“„ é€‰æ‹©çš„æ–‡ä»¶ï¼š</h3>";
        selectedFiles.forEach((file, index) => {
          html += `
                    <div class="file-info">
                        <strong>${file.name}</strong><br>
                        å¤§å°: ${formatFileSize(file.size)}<br>
                        ç±»å‹: ${file.type || "æœªçŸ¥"}
                        <button onclick="removeFile(${index})" style="float: right; background: #dc3545;">åˆ é™¤</button>
                    </div>
                `;
        });
        fileList.innerHTML = html;
      }

      function removeFile(index) {
        selectedFiles.splice(index, 1);
        updateFileList();
        updateUploadButton();
      }

      function updateUploadButton() {
        const uploadBtn = document.getElementById("uploadBtn");
        uploadBtn.disabled = selectedFiles.length === 0;
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      async function uploadFiles() {
        if (selectedFiles.length === 0) return;

        const resultDiv = document.getElementById("result");
        const progressContainer = document.getElementById("progressContainer");
        const progressBar = document.getElementById("progressBar");
        const uploadBtn = document.getElementById("uploadBtn");

        uploadBtn.disabled = true;
        progressContainer.style.display = "block";
        resultDiv.style.display = "none";

        try {
          for (let i = 0; i < selectedFiles.length; i++) {
            const file = selectedFiles[i];
            const progress = ((i + 1) / selectedFiles.length) * 100;
            progressBar.style.width = progress + "%";

            const formData = new FormData();
            formData.append("file", file);

            const response = await fetch(`${API_BASE_URL}/api/upload/file`, {
              method: "POST",
              headers: {
                Authorization: "Bearer " + getToken(),
              },
              body: formData,
            });

            const result = await response.json();

            if (!response.ok) {
              throw new Error(result.error || "ä¸Šä¼ å¤±è´¥");
            }

            console.log("ä¸Šä¼ æˆåŠŸ:", result);
          }

          resultDiv.className = "result success";
          resultDiv.innerHTML = `
                    <h4>âœ… ä¸Šä¼ æˆåŠŸï¼</h4>
                    <p>å·²æˆåŠŸä¸Šä¼  ${selectedFiles.length} ä¸ªæ–‡ä»¶</p>
                    <p>æ–‡ä»¶å·²ä¿å­˜åˆ°æœåŠ¡å™¨ï¼Œå¯ä»¥åœ¨èŠå¤©ä¸­å‘é€</p>
                `;
          resultDiv.style.display = "block";

          selectedFiles = [];
          updateFileList();
          updateUploadButton();
        } catch (error) {
          console.error("ä¸Šä¼ å¤±è´¥:", error);
          resultDiv.className = "result error";
          resultDiv.innerHTML = `
                    <h4>âŒ ä¸Šä¼ å¤±è´¥</h4>
                    <p>é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                    <p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œåç«¯æœåŠ¡çŠ¶æ€</p>
                `;
          resultDiv.style.display = "block";
        } finally {
          uploadBtn.disabled = false;
          progressContainer.style.display = "none";
          progressBar.style.width = "0%";
        }
      }

      function getToken() {
        // ä»localStorageè·å–tokenï¼Œå¦‚æœæ²¡æœ‰åˆ™æç¤ºç™»å½•
        const token = localStorage.getItem("im_token");
        if (!token) {
          alert("è¯·å…ˆç™»å½•ï¼");
          return null;
        }
        return token;
      }

      async function testHealth() {
        const apiResult = document.getElementById("apiResult");
        try {
          const response = await fetch(`${API_BASE_URL}/health`);
          const result = await response.json();
          apiResult.innerHTML = `
                    <div class="result success">
                        <h4>âœ… åç«¯å¥åº·æ£€æŸ¥é€šè¿‡</h4>
                        <p>çŠ¶æ€: ${result.status}</p>
                        <p>è¿è¡Œæ—¶é—´: ${Math.floor(result.uptime)} ç§’</p>
                        <p>æ—¶é—´æˆ³: ${result.timestamp}</p>
                    </div>
                `;
        } catch (error) {
          apiResult.innerHTML = `
                    <div class="result error">
                        <h4>âŒ åç«¯è¿æ¥å¤±è´¥</h4>
                        <p>é”™è¯¯: ${error.message}</p>
                        <p>è¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ</p>
                    </div>
                `;
        }
      }

      async function testAuth() {
        const apiResult = document.getElementById("apiResult");
        const token = getToken();
        if (!token) return;

        try {
          const response = await fetch(`${API_BASE_URL}/api/user/profile`, {
            headers: {
              Authorization: "Bearer " + token,
            },
          });

          if (response.ok) {
            const result = await response.json();
            apiResult.innerHTML = `
                        <div class="result success">
                            <h4>âœ… è®¤è¯çŠ¶æ€æ­£å¸¸</h4>
                            <p>ç”¨æˆ·: ${result.user.username}</p>
                            <p>é‚®ç®±: ${result.user.email || "æœªè®¾ç½®"}</p>
                        </div>
                    `;
          } else {
            throw new Error("è®¤è¯å¤±è´¥");
          }
        } catch (error) {
          apiResult.innerHTML = `
                    <div class="result error">
                        <h4>âŒ è®¤è¯å¤±è´¥</h4>
                        <p>é”™è¯¯: ${error.message}</p>
                        <p>è¯·é‡æ–°ç™»å½•</p>
                    </div>
                `;
        }
      }

      // é¡µé¢åŠ è½½æ—¶æµ‹è¯•åç«¯è¿æ¥
      window.addEventListener("load", testHealth);
    </script>
  </body>
</html>
